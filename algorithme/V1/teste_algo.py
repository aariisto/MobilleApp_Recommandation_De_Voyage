import psycopg2
import json
import logging
import numpy as np
from typing import List, Dict, Any
from sentence_transformers import SentenceTransformer

# Configuration du logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


def get_all_city_embeddings(conn_params: dict) -> List[Dict[str, Any]]:
    """
    Récupère tous les embeddings des villes stockés dans la base de données PostgreSQL.
    
    Args:
        conn_params: Dictionnaire contenant les paramètres de connexion :
                    {"host": str, "dbname": str, "user": str, "password": str, "port": int (optionnel)}
    
    Returns:
        Une liste de dictionnaires contenant id, name et embedding :
        [{"id": 1, "name": "Paris", "embedding": [0.1, 0.2, ...]}, ...]
    
    Raises:
        psycopg2.Error: En cas d'erreur de connexion ou de requête SQL
        Exception: En cas d'autre erreur
    """
    conn = None
    cursor = None
    
    try:
        # Ajout du port par défaut s'il n'est pas fourni
        if 'port' not in conn_params:
            conn_params['port'] = 5432
        
        logger.info(f"Connexion à PostgreSQL : {conn_params['host']}:{conn_params['port']}/{conn_params['dbname']}")
        
        # Connexion à la base de données
        conn = psycopg2.connect(**conn_params)
        cursor = conn.cursor()
        
        # Requête SQL
        query = """
            SELECT id, name, embedding 
            FROM cities 
            WHERE embedding IS NOT NULL
            ORDER BY id;
        """
        
        logger.info("Exécution de la requête SQL...")
        cursor.execute(query)
        
        # Récupération de tous les résultats
        results = cursor.fetchall()
        logger.info(f"{len(results)} villes trouvées avec embeddings")
        
        # Construction de la liste de dictionnaires
        cities = []
        for row in results:
            city_id, name, embedding = row
            
            # Conversion de l'embedding float8[] en liste Python
            if embedding is not None:
                # PostgreSQL retourne les arrays comme des listes Python
                if isinstance(embedding, list):
                    embedding_list = embedding
                else:
                    # En cas de chaîne, la parser
                    embedding_list = list(embedding) if embedding else []
            else:
                embedding_list = []
            
            city_dict = {
                "id": city_id,
                "name": name,
                "embedding": embedding_list
            }
            cities.append(city_dict)
        
        logger.info(f"✓ {len(cities)} embeddings récupérés avec succès")
        
        return cities
        
    except psycopg2.Error as e:
        logger.error(f"Erreur PostgreSQL: {e}")
        raise
    except Exception as e:
        logger.error(f"Erreur inattendue: {e}")
        raise
    finally:
        # Fermeture propre du curseur et de la connexion
        if cursor is not None:
            cursor.close()
            logger.debug("Curseur fermé")
        if conn is not None:
            conn.close()
            logger.debug("Connexion fermée")


def save_embeddings_to_json(cities: List[Dict[str, Any]], filename: str = "cities_embeddings.json"):
    """
    Sauvegarde la liste des embeddings dans un fichier JSON au dossier /algorithme.
    
    Args:
        cities: Liste de dictionnaires contenant les embeddings
        filename: Nom du fichier de sortie
    """
    try:
        # Chemin du dossier algorithme
        import os
        algorithme_dir = os.path.dirname(os.path.abspath(__file__))
        filepath = os.path.join(algorithme_dir, filename)
        
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(cities, f, ensure_ascii=False, indent=2)
        logger.info(f"✓ Embeddings sauvegardés dans '{filepath}'")
    except IOError as e:
        logger.error(f"Erreur lors de l'écriture du fichier: {e}")
        raise


def get_user_embedding(likes_text: str, dislikes_text: str = "") -> List[float]:
    """
    Génère un embedding pour un utilisateur en tenant compte de ses préférences (likes) et aversions (dislikes).
    
    La logique fonctionne ainsi :
    - On calcule un vecteur pour ce que l'utilisateur AIME
    - On calcule un vecteur pour ce que l'utilisateur N'AIME PAS
    - Le vecteur final = embedding_likes - embedding_dislikes
    
    Cela permet de "repousser" les résultats qui contiendraient les dislikes.
    
    Exemple :
        - likes_text = "plage restaurant"
        - dislikes_text = "montagne froid"
        - final = embedding(plage restaurant) - embedding(montagne froid)
        → Le système recommandera des destinations avec plage/restaurant
          ET évitera montagne/froid
    
    Args:
        likes_text: Le texte représentant ce que l'utilisateur AIME (obligatoire)
                   (ex: "plage restaurant shopping")
        dislikes_text: Le texte représentant ce que l'utilisateur N'AIME PAS (optionnel)
                      (ex: "montagne froid humidité")
    
    Returns:
        Une liste de floats représentant le vecteur d'embedding final (likes - dislikes)
    """
    try:
        logger.info("Chargement du modèle sentence-transformers...")
        # Chargement du modèle "all-MiniLM-L6-v2"
        model = SentenceTransformer('all-MiniLM-L6-v2')
        
        # Génération de l'embedding pour les préférences (likes)
        logger.info(f"Génération de l'embedding pour les préférences (likes): '{likes_text}'")
        embedding_likes = model.encode(likes_text)
        
        # Si dislikes_text est fourni, générer son embedding
        if dislikes_text and dislikes_text.strip():
            logger.info(f"Génération de l'embedding pour les aversions (dislikes): '{dislikes_text}'")
            embedding_dislikes = model.encode(dislikes_text)
            
            # Calcul du vecteur final : likes - dislikes
            # Cette soustraction "repousse" les résultats qui correspondent aux dislikes
            embedding_final = embedding_likes - embedding_dislikes
            logger.info("Calcul du vecteur final : embedding_likes - embedding_dislikes")
        else:
            # Si pas de dislikes, on utilise juste le embedding des likes
            logger.info("Pas de dislikes fourni, utilisation directe de l'embedding des likes")
            embedding_final = embedding_likes
        
        # Conversion en liste Python
        return embedding_final.tolist()
    
    except Exception as e:
        logger.error(f"Erreur lors de la génération de l'embedding utilisateur: {e}")
        raise


def cosine_similarity(vec1: list, vec2: list) -> float:
    """
    Calcule la similarité cosinus entre deux vecteurs.
    
    Args:
        vec1: Premier vecteur (liste de floats)
        vec2: Deuxième vecteur (liste de floats)
    
    Returns:
        Un float entre -1 et 1 représentant la similarité cosinus
        - 1.0 : vecteurs identiques
        - 0.0 : vecteurs orthogonaux
        - -1.0 : vecteurs opposés
    """
    try:
        # Conversion en arrays numpy
        v1 = np.array(vec1)
        v2 = np.array(vec2)
        
        # Calcul du produit scalaire
        dot_product = np.dot(v1, v2)
        
        # Calcul des normes
        norm_v1 = np.linalg.norm(v1)
        norm_v2 = np.linalg.norm(v2)
        
        # Vérification pour éviter la division par zéro
        if norm_v1 == 0 or norm_v2 == 0:
            logger.warning("Un des vecteurs a une norme nulle")
            return 0.0
        
        # Calcul de la similarité cosinus
        similarity = dot_product / (norm_v1 * norm_v2)
        
        return float(similarity)
    
    except Exception as e:
        logger.error(f"Erreur lors du calcul de la similarité cosinus: {e}")
        raise


def load_embeddings_from_json(filename: str = "cities_embeddings.json") -> List[Dict[str, Any]]:
    """
    Charge les embeddings des villes depuis un fichier JSON.
    
    Args:
        filename: Nom du fichier JSON à charger
    
    Returns:
        Liste de dictionnaires contenant id, name et embedding
    """
    try:
        import os
        algorithme_dir = os.path.dirname(os.path.abspath(__file__))
        filepath = os.path.join(algorithme_dir, filename)
        
        logger.info(f"Chargement des embeddings depuis '{filepath}'...")
        with open(filepath, 'r', encoding='utf-8') as f:
            cities = json.load(f)
        
        logger.info(f"✓ {len(cities)} villes chargées avec succès")
        return cities
    
    except IOError as e:
        logger.error(f"Erreur lors de la lecture du fichier: {e}")
        raise
    except json.JSONDecodeError as e:
        logger.error(f"Erreur de décodage JSON: {e}")
        raise


def rank_cities_by_similarity(user_text: str, cities: List[Dict[str, Any]], dislikes_text: str = "", output_filename: str = "ranked_cities.json") -> List[Dict[str, Any]]:
    """
    Classe les villes par similarité avec le texte utilisateur (likes et dislikes).
    
    Args:
        user_text: Texte utilisateur (ex: "plage restaurant shopping")
        cities: Liste des villes avec leurs embeddings
        dislikes_text: Texte des préférences à ÉVITER (optionnel)
        output_filename: Nom du fichier de sortie pour les résultats
    
    Returns:
        Liste des villes triées par similarité décroissante
    """
    try:
        logger.info(f"Calcul de la similarité pour: '{user_text}'")
        
        # Génération de l'embedding utilisateur (avec likes et optionnellement dislikes)
        user_embedding = get_user_embedding(user_text, dislikes_text)
        logger.info(f"✓ Embedding utilisateur généré (dimension: {len(user_embedding)})")
        
        # Calcul de la similarité pour chaque ville
        ranked_cities = []
        for city in cities:
            city_id = city["id"]
            city_name = city["name"]
            city_embedding = city["embedding"]
            
            # Calcul de la similarité
            similarity = cosine_similarity(user_embedding, city_embedding)
            
            ranked_cities.append({
                "id": city_id,
                "name": city_name,
                "similarity": similarity
            })
        
        # Tri par similarité décroissante
        ranked_cities.sort(key=lambda x: x["similarity"], reverse=True)
        
        logger.info(f"✓ {len(ranked_cities)} villes classées par similarité")
        
        # Sauvegarde dans un fichier JSON
        import os
        algorithme_dir = os.path.dirname(os.path.abspath(__file__))
        output_filepath = os.path.join(algorithme_dir, output_filename)
        
        with open(output_filepath, 'w', encoding='utf-8') as f:
            json.dump(ranked_cities, f, ensure_ascii=False, indent=2)
        
        logger.info(f"✓ Résultats sauvegardés dans '{output_filepath}'")
        
        return ranked_cities
    
    except Exception as e:
        logger.error(f"Erreur lors du classement des villes: {e}")
        raise


# Exemple d'utilisation
if __name__ == "__main__":
    
    
    try:
        print(cosine_similarity([0.11600243300199509, -0.013534399680793285, -0.017426086589694023, 0.046319328248500824, -0.0995878279209137, 0.0185683723539114, -0.06344688683748245, -0.07743526250123978, -0.05901837721467018, -0.0005843036924488842, 0.006501162890344858, -0.06929747760295868, -0.02080126665532589, 0.0835328921675682, 0.035159461200237274, 0.012197083793580532, 0.10540013015270233, 0.05260580778121948, 0.11443045735359192, -0.11198314279317856, -0.01972506381571293, -0.039486248046159744, 0.04977249354124069, -0.008050751872360706, 0.0142072644084692, 0.060417089611291885, 0.03248082846403122, 0.04125446453690529, 0.003998737316578627, -0.029940832406282425, -0.03496389836072922, 0.03563249111175537, -0.03667950630187988, 0.03384557366371155, -0.01467555109411478, 0.1100223958492279, -0.04201340675354004, -0.0878278911113739, 0.03722837194800377, -0.02145991101861, 0.03087913990020752, 0.05623715743422508, 0.04742276668548584, -0.05909229815006256, -0.0022360992152243853, -0.04086865484714508, 0.037403468042612076, 0.005899942945688963, 0.09533241391181946, 0.05900083854794502, 0.06363676488399506, 0.05311034247279167, 0.011643667705357075, -0.10737654566764832, 0.020909728482365608, -0.010684093460440636, -0.07456266134977341, -0.0480353906750679, -0.09078530967235565, -0.09881041198968887, 0.03328011929988861, 0.009678016416728497, -0.028689784929156303, -0.050621479749679565, -0.038664910942316055, -0.017512395977973938, -0.015576782636344433, 0.04016365483403206, 0.0452476441860199, -0.12124253064393997, 0.016308799386024475, -0.04555867984890938, 0.022824671119451523, 0.02591550350189209, 0.04477357119321823, -0.09504927694797516, -0.04596546292304993, -0.049376409500837326, -0.12079500406980515, 0.0411139652132988, 0.04747593775391579, 0.0011230919044464827, -0.015814948827028275, 0.007886651903390884, -0.06122426688671112, -0.04008025676012039, -0.014560512267053127, -0.014708157628774643, 0.018787529319524765, -0.005993911996483803, 0.05631205439567566, -0.019169898703694344, 0.01584267057478428, -0.07996254414319992, 0.05845000222325325, 0.03243964537978172, -0.05619038641452789, 0.04826172813773155, 0.016595283523201942, -0.003559246426448226, -0.03849383816123009, -0.013162982650101185, 0.020993594080209732, 0.03701358288526535, 0.003719778498634696, -0.04587789624929428, -0.0442233607172966, 0.03418699651956558, -0.04501171037554741, 0.0009784244466573, -0.020658111199736595, -0.02091214433312416, -0.014928534626960754, 0.011500823311507702, -0.00939114484935999, 0.08465005457401276, 0.0096114007756114, -0.06236101686954498, 0.038777124136686325, 0.005357806570827961, -0.017610710114240646, -0.058450765907764435, -0.023292850703001022, 0.03276502713561058, -0.05427803471684456, 0.03405023738741875, 0.008371812291443348, -1.0935133544150257e-33, -0.053615372627973557, 0.021661922335624695, -0.02740463614463806, 0.0025799500290304422, -0.017046449705958366, -0.025534428656101227, -0.04121715947985649, -0.052422430366277695, -0.04513111338019371, -0.10836198180913925, 0.09356200695037842, -0.04376138001680374, 0.02430838532745838, 0.03971795737743378, 0.03609069064259529, -0.002703485544770956, 0.005644700489938259, 0.02051682583987713, -0.014157112687826157, -0.08535800129175186, -0.018363341689109802, -0.06148344650864601, 0.07128824293613434, 0.00572609668597579, -0.021508516743779182, -0.04738285392522812, 0.0271909236907959, 0.05199682340025902, -0.021708156913518906, -0.0010280285496264696, 0.0016257751267403364, -0.01438051275908947, -0.018250413239002228, -0.047784123569726944, -5.04894633195363e-05, 0.09373458474874496, -0.031398992985486984, 0.004919581580907106, 0.0006436473340727389, 0.013534363359212875, -0.07823033630847931, -0.0035114723723381758, -0.04850178211927414, 0.1265554279088974, 0.03773828223347664, 0.06505092978477478, 0.02679741196334362, -0.021532073616981506, 0.04326591640710831, -0.044268470257520676, 0.010945126414299011, -0.024211876094341278, -0.11031406372785568, 0.0442107692360878, -0.030807722359895706, 0.026674648746848106, -0.015450828708708286, 0.0323973186314106, 0.011832836084067822, 0.027632277458906174, 0.015671048313379288, 0.061072736978530884, -0.019608149304986, -0.0016322663286700845, 0.05527091771364212, -0.01187572255730629, 0.03665680065751076, 0.03900519385933876, 0.018130110576748848, 0.03120576962828636, 0.055705633014440536, -0.0234528798609972, 0.1374010443687439, 0.053497109562158585, -0.01672317087650299, 0.1341070681810379, -0.01771487109363079, 0.031602419912815094, 0.04922541603446007, 0.024379393085837364, -0.009364411234855652, 0.025474954396486282, -0.06461697071790695, 0.06858193874359131, 0.020326370373368263, -0.00018970223027281463, 0.11084260791540146, -0.12678928673267365, -0.032851118594408035, -0.03569105640053749, -0.04877578839659691, 0.07580944150686264, 0.020989857614040375, -0.02724303863942623, -0.05054134503006935, 1.3109606616162e-34, 0.03302158787846565, -0.08160380274057388, 0.0019241936970502138, 0.04352135211229324, -0.03239607438445091, -0.05970300734043121, -0.03415229171514511, 0.0014367452822625637, 0.027678247541189194, -0.03220647573471069, -0.02804866060614586, 0.0012287466088309884, 0.07384651899337769, -9.460608271183446e-05, -0.05039932206273079, 0.038637351244688034, 0.04541337117552757, -0.05182662978768349, -0.11570413410663605, 0.07074407488107681, -0.03449251130223274, 0.10299988090991974, -0.11587788909673691, -0.08137396723031998, -0.04094759374856949, 0.030834071338176727, -0.12246561795473099, -0.07774996012449265, -0.06971490383148193, -0.009535258635878563, -0.06252147257328033, 0.017320238053798676, 0.007566586136817932, 0.029168345034122467, 0.02050398662686348, 0.09136123210191727, 0.06299521028995514, -0.02252887934446335, 0.003678998677060008, 0.09733753651380539, 0.04519618675112724, 0.028420768678188324, 0.03314629942178726, 0.05787248909473419, 0.049095407128334045, 0.08120054006576538, -0.08645572513341904, 0.03658062592148781, 0.04922790452837944, -0.09820152074098587, 0.036669597029685974, 0.007253741379827261, -0.002653184812515974, -0.018174849450588226, 0.06831662356853485, 0.06559991836547852, -0.05335438251495361, 0.0729902908205986, 0.011873189359903336, -0.02721470780670643, -0.04504038020968437, 0.04614005610346794, 0.013114262372255325, 0.07998756319284439, 0.03796902671456337, -0.02969755046069622, 0.0309080109000206, -0.013201171532273293, -0.0639379620552063, 0.022880878299474716, -0.023584062233567238, -0.013275986537337303, -0.02617739886045456, 0.02759307250380516, -0.0020266338251531124, -0.013894095085561275, 0.06428936123847961, 0.11530712246894836, 0.03217118978500366, 0.013172172009944916, 0.058061473071575165, -0.0066050272434949875, -0.08027765899896622, -0.008011572994291782, 0.11624366044998169, 0.07404150068759918, -0.06720015406608582, -0.011217795312404633, 0.05566364899277687, 0.025204697623848915, -0.04494749754667282, -0.02277331054210663, -0.05712210759520531, -0.10100321471691132, -0.003241403726860881, -2.5727658226060157e-08, -0.0012491631787270308, -0.030506648123264313, -0.045830138027668, 0.08572407066822052, -0.06572656333446503, -0.0807991623878479, 0.022830037400126457, 0.06114732846617699, -0.025395533069968224, 0.026116905733942986, -0.06554431468248367, 0.009159000590443611, -0.08836616575717926, 0.026246927678585052, -0.06483850628137589, -0.05000968277454376, 0.0014227761421352625, 0.000711306813172996, 0.016088709235191345, -0.05305150896310806, -0.014418229460716248, 0.01568695530295372, -0.00036245072260499, -0.021472720429301262, -0.024606000632047653, -0.007613382767885923, -0.03731841221451759, -0.06690696626901627, 0.06793046742677689, -0.005562151316553354, 0.002534764353185892, 0.049573831260204315, 0.0005835776682943106, -0.031012818217277527, 0.06764260679483414, -0.05345401167869568, -0.0479445606470108, -0.04112398624420166, -0.019455451518297195, -0.05966849625110626, 0.02342374064028263, -0.0122256800532341, -0.03364887088537216, 0.017009302973747253, 0.00455860560759902, -0.002775990404188633, 0.12247573584318161, -0.017843279987573624, -0.024340344592928886, 0.05535665154457092, -0.012297560460865498, -0.0073961541056632996, 0.07720567286014557, 0.029388034716248512, 0.06781129539012909, -0.03525928780436516, -0.05170593410730362, -0.015089079737663269, 0.08313798904418945, 0.044766977429389954, 0.12029373645782471, -0.02223646081984043, -0.039296943694353104, 0.012657544575631618], [0.0036934618838131428, 0.00207978836260736, -0.0131180165335536, -0.01818069815635681, 0.03864515945315361, -0.05264107882976532, -0.007089624181389809, 2.9967815862619318e-05, 0.006350443232804537, -0.030158093199133873, 0.0570601187646389, -0.03964010253548622, 0.010549883358180523, 0.0665610134601593, 0.03942803293466568, 0.04213222488760948, 0.042926620692014694, 0.016662025824189186, -0.025932759046554565, -0.0619189515709877, 0.005706016905605793, -0.05364994332194328, 0.0033469097688794136, 0.030315544456243515, -0.02242085710167885, 0.019573280587792397, 0.004995295777916908, -0.03536606580018997, 0.00787368044257164, 0.002662868006154895, 0.027526814490556717, 0.05458160117268562, -0.08029752224683762, 0.010738653130829334, -0.04544665291905403, 0.08712004870176315, -0.03901897743344307, -0.07220245152711868, 0.022249193862080574, -0.0012373351491987705, -0.04381958395242691, -0.013537448830902576, 0.06919287890195847, -0.011170241050422192, 0.009209651499986649, 0.04083087667822838, 0.011254566721618176, 0.031240301206707954, 0.09040322154760361, 0.016367556527256966, 0.07094378024339676, 0.08526104688644409, 0.026304226368665695, -0.06936179101467133, -0.03155171498656273, 0.013085669837892056, -0.10416021198034286, -0.16858714818954468, -0.023527812212705612, -0.04985378682613373, 0.005313372705131769, 0.002690908731892705, 0.04824024438858032, -0.030666109174489975, -0.07689834386110306, -0.030456839129328728, -0.07619766145944595, 0.06122960150241852, 0.018161529675126076, -0.08132260292768478, -0.007470809854567051, -0.0789504125714302, -0.01816781982779503, 0.0032422118820250034, 0.009217086248099804, -0.07066609710454941, 0.02471199259161949, -0.02598564699292183, -0.14954766631126404, 0.03347761929035187, 0.06833332031965256, 0.0027315872721374035, 0.0644870325922966, 0.018063398078083992, 0.03905067965388298, -0.08408630639314651, 0.02177397534251213, -0.012593123130500317, 0.022820215672254562, -0.017005223780870438, 0.039155445992946625, -0.04369735345244408, -0.0116110909730196, -0.02831299602985382, 0.03606654331088066, 0.06284182518720627, 0.018890421837568283, 0.026893582195043564, 0.0018206852255389094, 0.035360660403966904, -0.04825340211391449, -0.04373226314783096, 0.01999678649008274, 0.015279826708137989, -0.02407073974609375, -0.05735957995057106, 0.04334966838359833, 0.0889459177851677, 0.026295308023691177, -0.00525582255795598, -0.000893194111995399, -0.02589963935315609, 0.016514107584953308, 0.016361501067876816, -0.006596981547772884, 0.026540877297520638, 0.027346009388566017, -0.006127722095698118, -0.0022640491370111704, 0.011697070673108101, 0.054065071046352386, 0.02011236920952797, 0.025935722514986992, 0.05979849770665169, -0.004301181994378567, -0.013928629457950592, -0.013696662150323391, -6.2518419092643735e-34, -0.03596581146121025, 0.04244304448366165, -0.0803837925195694, 0.0635070651769638, -0.04844558984041214, 0.026359418407082558, 0.0008876462234184146, 0.0488615408539772, -0.0809461921453476, -0.09063232690095901, 0.07272914052009583, -0.035330191254615784, -0.06308238208293915, 0.05395769327878952, 0.019275102764368057, -0.00272983661852777, 0.010425293818116188, -0.02151923067867756, -0.04172249138355255, -0.09095200896263123, -0.045640166848897934, -0.06813113391399384, 0.07388302683830261, 0.00544292526319623, -0.019147727638483047, 0.01000220701098442, 0.019292525947093964, -0.027638869360089302, -0.013296821154654026, -0.001984726870432496, 0.035209111869335175, -0.028753768652677536, 0.028830647468566895, 0.005880724173039198, -0.003213898977264762, 0.0995754599571228, -0.06098240241408348, -0.028447488322854042, -0.02085910737514496, -0.013679997995495796, -0.10649114847183228, 0.02697877213358879, -0.029712237417697906, 0.0996323674917221, 0.005286267027258873, 0.09393630921840668, 0.030610233545303345, 0.02039221301674843, 0.05291246995329857, -0.04365545138716698, -0.09185921400785446, 0.030959805473685265, -0.1286616027355194, -0.016802102327346802, 0.005328720435500145, -0.031228769570589066, -0.03958997502923012, 0.01765044406056404, -0.02900637499988079, -0.0698501244187355, 0.025285551324486732, 0.027800852432847023, -0.07056841254234314, 0.02021794579923153, 0.05847371369600296, -0.0017948768800124526, 0.01230811607092619, 0.022749384865164757, -0.03579277917742729, 0.007887639105319977, 0.01590270921587944, 0.01176933292299509, 0.07866991311311722, 0.10121525079011917, 0.016775257885456085, 0.07047073543071747, 0.05386461317539215, -0.02691107802093029, 0.03724206984043121, -0.0066443271934986115, -0.009903134778141975, 0.056110769510269165, 0.03189639374613762, 0.10308269411325455, -0.06651107966899872, -0.0405341312289238, 0.06500445306301117, -0.10608640313148499, 0.02456216886639595, -0.04749274253845215, -0.027961373329162598, 0.05984770879149437, -0.023709557950496674, -0.028095873072743416, -0.08953239768743515, -5.543733295878643e-34, 0.03412647172808647, -0.06882122904062271, 0.04048420488834381, 0.038120683282613754, 0.025687286630272865, -0.0035274100955575705, -0.07828400284051895, -0.04674083739519119, 0.04134804382920265, 0.005026434548199177, -0.040130045264959335, 0.013997796922922134, -0.00658001285046339, -0.045825980603694916, 0.01857980713248253, 0.06089893728494644, 0.08591548353433609, -0.05561785399913788, -0.10069990903139114, 0.060419149696826935, -0.029474874958395958, 0.12007279694080353, -0.08616310358047485, -0.19269703328609467, -0.10165225714445114, 0.01658552512526512, -0.04807553440332413, -0.04857315123081207, -0.06198766082525253, -0.03536466509103775, -0.05090932920575142, 0.0045880344696342945, 0.06091611459851265, -0.058631621301174164, 0.048002444207668304, 0.08916480094194412, 0.012294281274080276, -0.04676137864589691, -0.09654399752616882, 0.08704238384962082, 0.05176825076341629, -0.02783091366291046, -0.010430715046823025, -0.012490789406001568, 0.045783549547195435, -0.024811632931232452, -0.08169229328632355, 0.009371981024742126, 0.05251806974411011, -0.08806212246417999, 0.05197398364543915, -0.04592706635594368, 0.012764886021614075, -0.026074891909956932, 0.06050857529044151, 0.03143196180462837, -0.03717289865016937, 0.05663289129734039, -0.002166754100471735, -0.023634862154722214, -0.012461354956030846, 0.034869637340307236, -0.0020471885800361633, 0.056585028767585754, -0.0009518379811197519, -0.02693442814052105, 0.0034640850499272346, -0.025137173011898994, -0.11579538881778717, 0.05701228231191635, 0.09363014250993729, -0.07504407316446304, -0.035162512212991714, 0.02243722230195999, -0.006652498617768288, 0.015734247863292694, 0.05611993744969368, 0.022111942991614342, -0.026471789926290512, -0.028833763673901558, 0.049276720732450485, -0.03324560448527336, 0.03518169745802879, -0.029428867623209953, 0.10043016076087952, 0.05436262488365173, 0.0074104443192481995, -0.041952840983867645, 0.004512395244091749, -0.04773502051830292, -0.01389086153358221, -0.04926083981990814, -0.017876122146844864, -0.03735169768333435, 0.06544086337089539, -2.697792744754679e-08, -0.04342169314622879, 0.02417631447315216, -0.06116797775030136, 0.024668758735060692, -0.055033549666404724, -0.05229736492037773, 0.060993634164333344, 0.0323009230196476, -0.0996396541595459, 0.08500891178846359, -0.07505486905574799, -0.006943196523934603, -0.037436265498399734, 0.0029709695372730494, 0.054021723568439484, -0.030236167833209038, 0.06397147476673126, 0.014214711263775826, 0.004258903209120035, 0.03004920482635498, 0.001267848419956863, 0.04880066588521004, 0.07283070683479309, -0.11115483194589615, -0.06862401962280273, 0.03590492904186249, 0.012628943659365177, -0.03615553304553032, 0.11736468970775604, -0.0532907210290432, 0.03333118557929993, 0.08082735538482666, 0.12851305305957794, 0.009332110174000263, 0.029850007966160774, -0.0010023199720308185, -0.09967914968729019, -0.044210582971572876, 0.005942158866673708, 0.027073392644524574, 0.0339851938188076, 0.022325938567519188, -0.038749005645513535, 0.04448171705007553, 0.10242445766925812, 0.026644837111234665, 0.04659874364733696, -0.06339319795370102, -0.036344800144433975, 0.04576226323843002, 0.01348433643579483, -0.036563389003276825, 0.09608152508735657, 0.056409429758787155, 0.04557769000530243, -0.07388204336166382, -0.01952417381107807, 0.022654596716165543, -0.0027026694733649492, 0.008363872766494751, 0.09017085283994675, 0.03020995296537876, -0.0773104652762413, 0.01584126427769661]))
    
    except Exception as e:
        print(f"Erreur lors du traitement: {e}")
    
    